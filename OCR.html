<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>OCR Test</title>

</head>
<body>
    
    
<!--<script src="vendor/jquery.Jcrop.js"></script>-->
<!--<link rel="stylesheet" href="jquery.Jcrop.min.css"/>-->
    

<h1>OCR Test</h1>

<div id="container">
    
    <!-- <script scr="ocrad.js">
    var string = OCRAD(image);
    alert(string);
    </script> -->
    
    
    <video id="video" width="640" height="480" autoplay></video>
<button id="snap">Snap Photo</button>
<canvas id="canvas" width="640" height="480"></canvas>

<!--<a href="#" class="button" id="btn-download">Download</a>-->
    <a id="download">Download Image</a>
    
    <script>

// Grab elements, create settings, etc.
var video = document.getElementById('video');

// Get access to the camera!
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // Not adding `{ audio: true }` since we only want video now
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        //video.src = window.URL.createObjectURL(stream);
        video.srcObject = stream;
        video.play();
    });
}
    
// Elements for taking the snapshot
var canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
var context = canvas.getContext('2d');
var video = document.getElementById('video');
        

        
// Trigger photo take
document.getElementById("snap").addEventListener("click", function() {
	context.drawImage(video, 0, 0, 640, 480);
});
        
        
function downloadCanvas(link, canvasId, filename) {
    link.href = document.getElementById(canvasId).toDataURL();
    link.download = filename;
}
        
document.getElementById('download').addEventListener('click', function() {
    downloadCanvas(this, 'canvas', 'test.png');
}, false);
        
</script>
    
     


<!--
<script>
var button = document.getElementById('btn-download');
button.addEventListener('click', function (e) {
    var dataURL = canvas.toDataURL('image/png');
    button.href = dataURL;
});    
    
    
document.getElementById('download').addEventListener('click', function() {
    downloadCanvas(this, 'canvas', 'test.png');
}, false);

</script>
-->


<!--<a href="#" class="button" id="btn-download" download="my-file-name.png">Download</a>-->
    
    
<script src="java.js"></script>

    
    
<!--    <div class="jumbotron">-->
<!--        <div id="step1">-->
<!--
            <h1><i class="glyphicon glyphicon-camera"></i></h1>

            <p class="lead">
                Take a good picture of a huge, printed text.
                <i class="glyphicon glyphicon-question-sign help" data-placement="bottom"
                   data-content="<img src='img/step1.png' />" data-html="true"></i>
            </p>

            <figure class="not-ready">
                <video autoplay></video>
            </figure>

            <button class="btn btn-lg btn-success" disabled id="takePicture">Take a picture</button>
        </div>
-->
    
    

<div id="step2">
            <h1><i class="glyphicon glyphicon-pencil"></i></h1>

            <p class="lead">
                Crop the picture and adjust it so that text is clearly visible.
                <i class="glyphicon glyphicon-question-sign help" data-placement="bottom"
                   data-content="<img src='img/step2.png' />" data-html="true"></i>
            </p>

            <figure>
                <canvas style="display:none"></canvas>
                <img src=""/>
            </figure>

            <p>Brightness: <input type="range" min="0" max="100" id="brightness" value="20"></p>

            <p>Contrast: <input type="range" min="0" max="100" id="contrast" value="90"></p>

            <button class="btn btn-lg btn-success" id="adjust" disabled>Done</button>
        </div>
    
    <script>texture = fxCanvas.texture(canvas);
        fxCanvas.draw(texture)
            .hueSaturation(-1, -1)//grayscale
            .unsharpMask(20, 2)
            .brightnessContrast(0.2, 0.9)
            .update();

        window.texture = texture;
        window.fxCanvas = fxCanvas;

        $(img)
            //setup the crop utility
            .one('load', function () {
                if (!$(img).data().Jcrop) {
                    $(img).Jcrop({
                        onSelect: function () {
                            //Enable the 'done' button
                            $('#adjust').removeAttr('disabled');
                        }
                    });
                } else {
                    //update crop tool (it creates copies of <img> that we have to update manually)
                    $('.jcrop-holder img').attr('src', fxCanvas.toDataURL());
                }
            })
            //show output from glfx.js
            .attr('src', fxCanvas.toDataURL());</script>
    
    <div id="step3">
            <h1><i class="glyphicon glyphicon-text-height"></i></h1>

            <p class="lead">You'll find the recognized text below.</p>

            <figure>
                <canvas></canvas>
            </figure>

            <blockquote>
                <div class="spinner">
                    <div class="bounce1"></div>
                    <div class="bounce2"></div>
                    <div class="bounce3"></div>
                </div>
                <p id="result"></p>
                <footer></footer>
            </blockquote>

            <button class="btn btn-lg btn-default" id="go-back">Go back</button>
            <button class="btn btn-lg btn-default" id="start-over">Start over</button>
        </div>
    
    
    <input type="file" style="position:absolute; top: -100px" id="picker" onchange="picked_file(this.files[0])">

<div id="demo">
                
                <canvas id='c' class="" width="600" height="300"></canvas>
                <div class="buttons">
                    <div id="clear" onclick="reset_canvas()">&times;</div>
                    <div id="word" onclick="da_word()">&#8635;</div>
                </div>
                 <div class="output nose" style="padding: 25px; cursor: pointer" onclick="open_picker()"> 
                    You can also <strong>drag and drop</strong> an image from your computer <small>(JPEG, PNG, GIF, BMP, SVG, or NetPBM)</small> to feed into the text recognizer or <strong>choose a file</strong> by clicking anywhere on this box. 
                    
                </div>
<div class="output">

                    <div id="output">
                        <div id="text"></div>
                        <span id="timing"></span>
                    </div>
                </div>
            </div>

            <style>
                #demo {
                box-shadow: 0px 0px 35px rgba(0,0,0,0.2);
                margin-bottom: 50px;
                background: white;
            }
            #demo {
                box-shadow: 0px 0px 35px rgba(0,0,0,0.2);
                margin-bottom: 50px;
                background: white;
            }
            .output {
                background: rgb(255, 245, 211);
            }
            #output {
                padding: 20px;
                padding-bottom: 0;
                text-align: center; 
                min-height: 80px;
                -moz-transition: background-color 0.5s;
                -webkit-transition: background-color 0.5s;
                -o-transition: background-color 0.5s;
                transition: background-color 0.5s;
            }
            .buttons #clear { color: red; font-size: 400%; font-weight: bold; cursor: pointer;}
			.buttons #word { color: blue; font-size: 300%; font-weight: bold; cursor: pointer; margin-left: -2px;}
			.nose {
				-moz-transition: background-color 0.5s;
				-webkit-transition: background-color 0.5s;
				-o-transition: background-color 0.5s;
				transition: background-color 0.5s;
			}
			.nose:hover {
				background-color: rgb(255, 222, 211);
			}
            
            </style>

            <script src="ocrad.js"></script>

            <script>

            var c = document.getElementById('c'),
                o = c.getContext('2d');

            function reset_canvas(){
                o.fillStyle = 'white'
                o.fillRect(0, 0, c.width, c.height)
                o.fillStyle = 'black'   
            }


            // here's a really simple little drawing app so people can try their luck at
            // the lottery that is offline handwriting recognition
            var drag = false, lastX, lastY;
            c.onmousedown = function(e){ drag = true; lastX = 0; lastY = 0; e.preventDefault(); c.onmousemove(e) }
            c.onmouseup   = function(e){ drag = false; e.preventDefault(); runOCR() }
            c.onmousemove = function(e){
                e.preventDefault()
                var rect = c.getBoundingClientRect();
                var r = 5;

                function dot(x, y){
                    o.beginPath()
                    o.moveTo(x + r, y)
                    o.arc(x, y, r, 0, Math.PI * 2)
                    o.fill()
                }
                if(drag){
                    var x = e.clientX - rect.left, 
                        y = e.clientY - rect.top;
                    
                    if(lastX && lastY){
                        var dx = x - lastX, dy = y - lastY;
                        var d = Math.sqrt(dx * dx + dy * dy);
                        for(var i = 1; i < d; i += 2){
                            dot(lastX + dx / d * i, lastY + dy / d * i)
                        }
                    }
                    dot(x, y)

                    lastX = x;
                    lastY = y;
                }
            }


            document.body.ondragover = function(){ document.body.className = 'dragging'; return false }
            document.body.ondragend = function(){ document.body.className = ''; return false }
            document.body.onclick = function(){document.body.className = '';}
            document.body.ondrop = function(e){
                e.preventDefault();
                document.body.className = '';
                picked_file(e.dataTransfer.files[0]);
                return false;
            }

             function open_picker(){
                 var e = document.createEvent("MouseEvents");    
                 e.initEvent('click', true, true);
                 document.getElementById('picker').dispatchEvent(e);
             }

            function picked_file(file){
                if(!file) return;
                 document.getElementById("output").className = 'processing'

                var ext = file.name.split('.').slice(-1)[0];
                var reader = new FileReader();

                if(file.type == "image/x-portable-bitmap" || ext == 'pbm' || ext == 'pgm' || ext == 'pnm' || ext == 'ppm'){
                    reader.onload = function(){
                        reset_canvas();
                        document.getElementById("text").innerHTML = 'Recognizing Text... This may take a while...'
                        o.font = '30px sans-serif'
                        o.fillText('No previews for NetPBM format.', 50, 100);
                        runOCR(new Uint8Array(reader.result), true);
                    }
                    reader.readAsArrayBuffer(file)
                }else{
                    reader.onload = function(){
                        var img = new Image();
                        img.src = reader.result;
                        img.onerror = function(){
                            reset_canvas();
                            o.font = '30px sans-serif'
                            o.fillText('Error: Invalid Image ' + file.name, 50, 100);
                        }
                        img.onload = function(){
                            document.getElementById("text").innerHTML = 'Recognizing Text... This may take a while...'
                            reset_canvas();
                            var rat = Math.min(c.width / img.width, c.height / img.height);
                            o.drawImage(img, 0, 0, img.width * rat, img.height * rat)
                            var tmp = document.createElement('canvas')
                            tmp.width = img.width;
                            tmp.height = img.height;
                            var ctx = tmp.getContext('2d')
                            ctx.drawImage(img, 0, 0)
                            var image_data = ctx.getImageData(0, 0, tmp.width, tmp.height);
                            runOCR(image_data, true)
                        }
                        
                    }
                    reader.readAsDataURL(file)
                }
                
            }

            var lastWorker;
            var worker = new Worker('worker.js')
            function runOCR(image_data, raw_feed){
                document.getElementById("output").className = 'processing'
                worker.onmessage = function(e){

                    document.getElementById("output").className = ''
                    
                    if('innerText' in document.getElementById("text")){
                        document.getElementById("text").innerText = e.data
                    }else{
                        document.getElementById("text").textContent = e.data    
                    }
                    document.getElementById('timing').innerHTML = 'recognition took ' + ((Date.now() - start)/1000).toFixed(2) + 's';
                }
                var start = Date.now()
                if(!raw_feed){
                    image_data = o.getImageData(0, 0, c.width, c.height);   
                }

                worker.postMessage(image_data)
                lastWorker = worker;
            }



            reset_canvas()

    
            var fonts = ['Droid Sans', 'Philosopher', 'Alegreya Sans', 'Chango', 'Coming Soon', 'Allan', 'Cardo', 'Bubbler One', 'Bowlby One SC', 'Prosto One', 'Rufina', 'Cantora One', 'Denk One', 'Play', 'Architects Daughter', 'Nova Square', 'Inder', 'Gloria Hallelujah', 'Telex', 'Comfortaa', 'Merienda', 'Boogaloo', 'Krona One', 'Orienta', 'Sofadi One', 'Source Sans Pro', 'Revalia', 'Overlock', 'Kelly Slab', 'Rye', 'Butcherman', 'Lato', 'Milonga', 'Aladin', 'Princess Sofia', 'Audiowide', 'Italiana', 'Michroma', 'Cabin Condensed', 'Jura', 'Marko One', 'PT Mono', 'Bubblegum Sans', 'Amaranth']
            

            function fisher_yates(a) {
                for (var i = a.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = a[i]; a[i] = a[j]; a[j] = temp;
                }
            }

            fisher_yates(fonts);
            // fisher_yates(quotes);

            function da_word(){
                reset_canvas()
                
                var font = fonts.shift(); fonts.push(font); // do a rotation

                if(Math.random() > 0.7){
                    var phrase = font;
                }else{
                    var phrase = quotes.shift() //quotes[Math.floor(quotes.length * Math.random())];
                    quotes.push(phrase);
                }
                
                WebFont.load({
                    google: {
                        families: [font]
                    },
                    active: function(){
                        o.font = '30px "' + font + '"'
                        var words = phrase.split(' '), buf = [], n = 70;
                        for(var i = 0; i < words.length; i++){
                            buf.push(words[i])
                            if(buf.join(' ').length > 15 || i == words.length - 1){
                                o.fillText(buf.join(' '), 50, n);
                                buf = []
                                n += 50
                            }
                        }
                        runOCR(phrase);
                    }
                })
            }

            o.font = '30px sans-serif'
            o.fillText("Welcome to the Ocrad.js Demo!", 50, 100);
            runOCR();
        </script>

<!--     <div id="step1">
            <h1><i class="glyphicon glyphicon-camera"></i></h1>
            <p3>Take a picture of the best before date</p3>
            <p class="lead">
                <i class="glyphicon glyphicon-question-sign help" data-placement="bottom"
                   data-content="<img src='img/step1.png' />" data-html="true"></i>
            </p>

            <figure class="not-ready">
                <video autoplay></video>
            </figure>

            <button class="btn btn-lg btn-success" disabled id="takePicture">Take a picture</button>
        </div>
    <div id="step2">
            <h1><i class="glyphicon glyphicon-pencil"></i></h1>

            <p class="lead">
                Crop the picture and adjust it so that text is clearly visible.
                <i class="glyphicon glyphicon-question-sign help" data-placement="bottom"
                   data-content="<img src='img/step2.png' />" data-html="true"></i>
            </p>

            <figure>
                <canvas style="display:none"></canvas>
                <img src=""/>
            </figure>

            <p>Brightness: <input type="range" min="0" max="100" id="brightness" value="20"></p>

            <p>Contrast: <input type="range" min="0" max="100" id="contrast" value="90"></p>

            <button class="btn btn-lg btn-success" id="adjust" disabled>Done</button>
        </div>
        <div id="step3">
            <h1><i class="glyphicon glyphicon-text-height"></i></h1>

            <p class="lead">You'll find the recognized text below.</p>

            <figure>
                <canvas></canvas>
            </figure>

            <button class="btn btn-lg btn-default" id="go-back">Go back</button>
            <button class="btn btn-lg btn-default" id="start-over">Start over</button>
        </div>



</div>

<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="vendor/modernizr.min.js"></script>
<script src="vendor/bootstrap.min.js"></script>
<script src="vendor/jquery.Jcrop.js"></script>
<script src='https://cdn.jsdelivr.net/gh/naptha/tesseract.js@v1.0.14/dist/tesseract.min.js'></script>
<script src="vendor/glfx.min.js"></script>
<script src="java.js"></script> -->

</body>
</html>
